{
	email {$EMAIL}
}

{$DOMAIN} {
	# 301 Redirects
	# redir /old-path /new-path permanent

	root * /srv
	file_server {
		hide .*
		precompressed br gzip
	}

	# Compression (fallback for non-precompressed files)
	encode gzip zstd

	# Security headers
	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "strict-origin-when-cross-origin"
		Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
		Cross-Origin-Resource-Policy "same-origin"
		Cross-Origin-Opener-Policy "same-origin"
		# Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
		# Content-Security-Policy "default-src 'self'; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; img-src 'self' data:; object-src 'none'; script-src 'self' 'wasm-unsafe-eval'; style-src 'self'; upgrade-insecure-requests"
		-Server
	}

	# Clean URLs
	try_files {path} {path}.html {path}/index.html {path}/index.xml

	# Cache static assets
	@static path *.css *.js *.ico *.gif *.jpg *.jpeg *.png *.svg *.webp *.avif *.woff *.woff2 *.mp3
	header @static Cache-Control "public, max-age=31536000, immutable"

	# Cache HTML with revalidation
	@html path *.html
	header @html Cache-Control "public, max-age=3600, must-revalidate"

	# Custom 404 page
	handle_errors {
		@404 expression {http.error.status_code} == 404
		handle @404 {
			rewrite * /404.html
			file_server
		}
	}

	log {
		output file /var/log/caddy/access.log {
			roll_size 10mb
			roll_keep 5
		}
		format json
	}
}

www.{$DOMAIN} {
	redir https://{$DOMAIN}{uri} permanent
}
